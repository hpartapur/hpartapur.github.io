<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Excel to Firebase</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
		<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
		<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
		<!-- Add Firebase products that you want to use -->
		<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
	</head>
	<body>
		<input type="file" id="upload" accept=".xlsx, .xls" />
		<button id="convert">Upload and Convert</button>
		<div id="result"></div>
		<button id="copyLink" style="display: none">Copy Link</button>

		<script type="module">
			// display the questions
			// display players
			// get url params
			// add button for copying admin link

			// Get URL parameters

			import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
			import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-analytics.js";
			import { getDatabase, ref, push, onValue, set, get, update } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
			// Your web app's Firebase configuration
			const firebaseConfig = {
				apiKey: "AIzaSyCooPWsrh3yFb4eat6dg2_VFAIIPF_ET50",
				authDomain: "khardal.firebaseapp.com",
				projectId: "khardal",
				storageBucket: "khardal.appspot.com",
				messagingSenderId: "258618544710",
				appId: "1:258618544710:web:2b734571b863de60dc3047",
			};

			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);

			const urlParams = new URLSearchParams(window.location.search);
			const code = urlParams.get("code");
			if (code) {
				document.getElementById("convert").style.display = "none";
				document.getElementById("upload").style.display = "none";
				document.getElementById("result").innerText = "Code: " + code;
				// Pull data from Firebase
				firebase
					.database()
					.ref("tarwiz")
					.on("value", function (snapshot) {
						var data = snapshot.val()[code];
						var sessions = Object.values(data.sessions);

						var tabler = `<table class="table-success table-responsive"><tr><th>ID</th><th>Score</th><th>Timestamp</th></tr>`;
						// Iterate over sessions data
						sessions.forEach((session) => {
							tabler += `<tr><td>${session.id}</td><td>${session.score}</td><td>${session.timestamp}</td></tr>`;
							console.log(session.id);
						});
						tabler += `</table`;
						document.write(tabler);
					});
			} else {
				document.getElementById("convert").addEventListener("click", function () {
					var file = document.getElementById("upload").files[0];
					var reader = new FileReader();
					reader.onload = function (e) {
						var data = new Uint8Array(e.target.result);
						var workbook = XLSX.read(data, { type: "array" });
						var firstSheetName = workbook.SheetNames[0];
						var worksheet = workbook.Sheets[firstSheetName];
						var json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
						var keys = json.shift();
						var jsonData = json.map((row) => {
							return keys.reduce((obj, key, index) => {
								if (row[index] !== undefined) {
									obj[key] = row[index];
								}
								return obj;
							}, {});
						});
						var quizTitle = prompt("Enter Quiz Title");
						var uploadData = {
							questions: jsonData,
							timestamp: new Date().toISOString(),
							quizTitle: quizTitle,
						};

						// Push to Firebase
						var ref = firebase
							.database()
							.ref("tarwiz")
							.push(uploadData, function (error) {
								if (error) {
									alert("Data could not be saved." + error);
								} else {
									var pushCode = ref.key;
									document.getElementById("result").innerText = "Push Code: " + pushCode;
									var copyButton = document.getElementById("copyLink");
									copyButton.style.display = "inline";
									copyButton.onclick = function () {
										navigator.clipboard.writeText(`khardal.net/tarwiz.html?code=${pushCode}`).then(
											function () {
												alert(
													'Link copied to clipboard. You can use the same link to access the quiz as an admin by changing "tarwiz" to "tarwiz-admin".'
												);
											},
											function () {
												alert("Failed to copy link");
											}
										);
									};
								}
							});
					};
					reader.readAsArrayBuffer(file);
				});
			}
		</script>
	</body>
</html>
