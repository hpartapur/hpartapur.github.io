<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Tarwiz Admin</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
	</head>
	<body>
		<div class="container mt-4">
			<h1>Tarwiz Admin</h1>

			<button id="downloadTemplate" class="btn btn-primary mb-3">Download Quiz Template</button>
			<input type="file" id="upload" accept=".xlsx, .xls" class="mb-2" />
			<button id="convert" class="btn btn-success mb-3">Upload and Convert</button>
			<!-- Quiz Options Form -->
			<div class="mt-4" hidden>
				<h2>Quiz Options</h2>
				<form id="quizOptionsForm">
					<div class="form-group">
						<label for="shuffle">Shuffle Questions</label>
						<input type="checkbox" id="shuffle" checked />
					</div>
					<div class="form-group">
						<label for="questionlimited">Limit Questions</label>
						<input type="checkbox" id="questionlimited" checked />
					</div>
					<div class="form-group" id="questionLimitGroup">
						<label for="questionlimit">Question Limit</label>
						<input type="number" id="questionlimit" value="30" min="1" />
					</div>
					<div class="form-group">
						<label for="timelimited">Time Limited</label>
						<input type="checkbox" id="timelimited" checked />
					</div>
					<div class="form-group" id="timeLimitGroup">
						<label for="timelimit">Time Limit (in minutes)</label>
						<input type="number" id="timelimit" value="20" min="1" />
					</div>
				</form>
			</div>
			<button id="export" class="btn btn-warning mb-3" style="display: none">Export to Excel</button>

			<button id="previewQuestions" class="btn btn-info mb-3" style="display: none" data-toggle="modal" data-target="#questionsModal">
				Preview Questions
			</button>
			<button id="copyLink" class="btn btn-info" style="display: none">Copy Link</button>
			<button class="btn btn-secondary mb-3" data-toggle="modal" data-target="#tutorialModal">Help</button>
			<div id="result"></div>

			<!-- Spinner -->
			<div id="spinnerContainer" class="d-none text-center mb-3">
				<div class="spinner-border" role="status">
					<span class="sr-only">Loading...</span>
				</div>
				<p>Loading...</p>
			</div>
		</div>

		<!-- Tutorial Modal -->
		<div class="modal fade" id="tutorialModal" tabindex="-1" role="dialog" aria-labelledby="tutorialModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="tutorialModalLabel">Tarwiz Admin Tutorial</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<h6>Step 1: Download the Quiz Template</h6>
						<p>Click the "Download Quiz Template" button to get the Excel file for quiz preparation.</p>
						<h6>Step 2: Prepare Your Quiz Data</h6>
						<p>Open the downloaded template, fill in your quiz questions, and save it in .xlsx or .xls format.</p>
						<h6>Step 3: Upload Your Quiz</h6>
						<p>Click "Choose File" to upload your prepared Excel file and then click "Upload and Convert".</p>
						<h6>Step 4: Enter Quiz Title</h6>
						<p>When prompted, enter a title for your quiz.</p>
						<h6>Step 5: Copy the Link</h6>
						<p>Once the upload is successful, click "Copy Link" to save the link for accessing your quiz.</p>
						<h6>Step 6: Access an Existing Quiz</h6>
						<p>To view an existing quiz, append the quiz code to the URL: <code>khardal.net/tarwiz.html?code=YOUR_CODE</code>.</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Questions Modal -->
		<div class="modal fade" id="questionsModal" tabindex="-1" role="dialog" aria-labelledby="questionsModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="questionsModalLabel">Questions</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div id="questionsTableContainer"></div>
					</div>
				</div>
			</div>
		</div>

		<script type="module">
			import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
			import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

			// Your web app's Firebase configuration
			const firebaseConfig = {
				apiKey: "AIzaSyCooPWsrh3yFb4eat6dg2_VFAIIPF_ET50",
				authDomain: "khardal.firebaseapp.com",
				projectId: "khardal",
				storageBucket: "khardal.appspot.com",
				messagingSenderId: "258618544710",
				appId: "1:258618544710:web:2b734571b863de60dc3047",
			};

			// Initialize Firebase
			const app = initializeApp(firebaseConfig);
			window.database = getDatabase(app);

			// Download template functionality
			document.getElementById("downloadTemplate").addEventListener("click", function () {
				const link = document.createElement("a");
				link.href = "assets/tarwiz-template.xlsx"; // Replace with the actual path to your template file
				link.download = "tarwiz-template.xlsx"; // Set the filename
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			});

			const urlParams = new URLSearchParams(window.location.search);
			const code = urlParams.get("code");

			if (code) {
				document.getElementById("convert").style.display = "none";
				document.getElementById("upload").style.display = "none";
				document.getElementById("result").innerText = "Code: " + code;

				// Show spinner
				document.getElementById("spinnerContainer").classList.remove("d-none");
				const dbRef = ref(getDatabase(), "tarwiz/" + code);

				// Pull data from Firebase
				onValue(dbRef, (snapshot) => {
					// Hide spinner
					document.getElementById("spinnerContainer").classList.add("d-none");

					var data = snapshot.val();
					console.log(data);
					if (data.sessions) {
						var sessions = Object.values(data.sessions);
						// Scores Table
						var scoreTable = `<h2>Scores</h2><table style='width:40vw;' class="table table-info table-responsive"><tr><th>ID</th><th>Score</th><th>Timestamp</th></tr>`;
						sessions.forEach((session) => {
							scoreTable += `<tr><td>${session.id}</td><td>${session.score}</td><td>${session.timestamp}</td></tr>`;
						});
						scoreTable += `</table>`;

						document.getElementById("result").innerHTML += scoreTable;
					}

					var questions = data.questions || [];

					// Prepare questions table for modal
					var questionTable = `<table style='width:100%;' class="table table-secondary"><tr><th>Question</th><th>Answer</th><th>Wrong Answers</th></tr>`;
					questions.forEach((question) => {
						var wrongAnswers = [];
						for (let i = 1; i <= 3; i++) {
							if (question[`Wrong Answer ${i}`]) {
								wrongAnswers.push(question[`Wrong Answer ${i}`]);
							}
						}
						questionTable += `<tr>
                                        <td>${question.Question}</td>
                                        <td class='table-success'>${question["Correct Answer"]}</td>
                                        <td class='table-danger'>${wrongAnswers.join(", ")}</td>
                                    </tr>`;
					});
					questionTable += `</table>`;

					document.getElementById("questionsTableContainer").innerHTML = questionTable;
					document.getElementById("previewQuestions").style.display = "block";
					document.getElementById("copyLink").style.display = "block";
				});

				document.getElementById("copyLink").addEventListener("click", function () {
					navigator.clipboard.writeText("https://khardal.net/tarwiz.html?code=" + code).then(() => {
						alert("Link copied to clipboard!");
					});
				});
			}

			document.getElementById("convert").addEventListener("click", function () {
				const fileInput = document.getElementById("upload");
				const file = fileInput.files[0];

				if (!file) {
					alert("Please upload a file.");
					return;
				}

				const reader = new FileReader();
				reader.onload = function (e) {
					const data = new Uint8Array(e.target.result);
					const workbook = XLSX.read(data, { type: "array" });
					const firstSheetName = workbook.SheetNames[0];
					const worksheet = workbook.Sheets[firstSheetName];
					const json = XLSX.utils.sheet_to_json(worksheet);

					const dirtyquestions = json.map((row) => ({
						Question: row["Question"],
						"Correct Answer": row["Correct Answer"],
						"Wrong Answer 1": row["Wrong Answer 1"],
						"Wrong Answer 2": row["Wrong Answer 2"],
						"Wrong Answer 3": row["Wrong Answer 3"],
					}));

					// Remove undefined properties
					const questions = dirtyquestions.map((question) => {
						return Object.fromEntries(Object.entries(question).filter(([key, value]) => value !== undefined));
					});

					console.log(questions);

					const quizData = {
						title: prompt("Enter quiz title:"),
						questions: questions,
						sessions: {},
					};

					// Show spinner
					document.getElementById("spinnerContainer").classList.remove("d-none");

					const newQuizRef = push(ref(getDatabase(), "tarwiz"));
					set(newQuizRef, quizData)
						.then(() => {
							// Hide spinner
							document.getElementById("spinnerContainer").classList.add("d-none");
							alert("Quiz uploaded successfully!");
							location.href = `?code=${newQuizRef.key}`;
						})
						.catch((error) => {
							console.error("Error uploading quiz:", error);
							document.getElementById("spinnerContainer").classList.add("d-none");
							alert("Error uploading quiz: " + error.message);
						});
				};
				reader.readAsArrayBuffer(file);
			});

			// Quiz options visibility
			document.getElementById("questionlimited").addEventListener("change", function () {
				const questionLimitGroup = document.getElementById("questionLimitGroup");
				questionLimitGroup.style.display = this.checked ? "block" : "none";
			});

			document.getElementById("timelimited").addEventListener("change", function () {
				const timeLimitGroup = document.getElementById("timeLimitGroup");
				timeLimitGroup.style.display = this.checked ? "block" : "none";
			});

			// Initialize visibility based on the initial state of the checkboxes
			document.getElementById("questionLimitGroup").style.display = document.getElementById("questionlimited").checked ? "block" : "none";
			document.getElementById("timeLimitGroup").style.display = document.getElementById("timelimited").checked ? "block" : "none";
		</script>

		<!-- Include Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
	</body>
</html>
