<!DOCTYPE html>
<!-- TODO: Figure out how to set a timer -->
<!-- ratios-keyboard  -->
<!-- add google auth and anon auth -->
<!-- changing background with colors -->
<!-- friend challenges -->
<!-- make leaderboard popup when new highscore -->
<!-- Do not let user play until login -->
<!-- Phase out cookies and replace with firebase pulled data -->
<!-- simplify pulldata -->
<html>
  <head>
    <meta name="google-adsense-account" content="ca-pub-7620239072665997">
    <meta charset="UTF-8">
    <meta name="description" content="Type-Righter is a game that helps you learn to type in Arabic.">
    <link rel="icon" type="image/jpg" href="logo.png">
    <title>Type-Righter</title>
    <script src="libraries/p5.min.js" type="text/javascript"></script>
    <script src="libraries/p5.sound.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href = "style.css">
    <!-- Add Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Audiowide">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZJM8TVT5H6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZJM8TVT5H6');
    </script>
  </head>

  <body>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-analytics.js";
      import { getDatabase, ref, push, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
      import { getFirestore, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
      import { getAuth, signInWithPopup,GoogleAuthProvider, onAuthStateChanged, signOut} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyCwcVRnXVs5M8EWEipwRgBREInAMgvj36s",
        authDomain: "khardal-typist.firebaseapp.com",
        databaseURL: "https://khardal-typist-default-rtdb.firebaseio.com",
        projectId: "khardal-typist",
        storageBucket: "khardal-typist.appspot.com",
        messagingSenderId: "277127524840",
        appId: "1:277127524840:web:c94fb2984ae4b694afb45d",
        measurementId: "G-JK8X82LLSX"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      window.database = getDatabase(app);

      const provider = new GoogleAuthProvider();



      auth.onAuthStateChanged(function(user) {
      if(user) {
        window.user = user;

        if (user.metadata.creationTime == user.metadata.lastSignInTime){
        // add user to database
        set(ref(database, 'users/'+user.uid), {
          name: user.displayName,
          email: user.email,
          photo:user.photoURL,
          phoneNumber: user.phoneNumber,
          dateJoined: user.metadata.creationTime,
          highscore: highscore,
        });
      }



        // add image to navbar
        document.getElementById("profile").innerHTML = "<img src='"+user.photoURL+"' style='height: 4vh; border-radius: 50% '> "+user.displayName

        console.log("Logged in as: " + user.displayName)
        document.getElementById("logout").style.display='block'
        document.getElementById("profile").style.hidden = 'block'


        console.log(user)
      } else {
        window.user = null;
        document.getElementById("logout").style.display = 'none'
        document.getElementById("profile").style.display = 'none'
        console.log("Not logged in")
        signInWithPopup(auth, provider)
      .then((result) => {
        // This gives you a Google Access Token. You can use it to access the Google API.
        const credential = GoogleAuthProvider.credentialFromResult(result);
        const token = credential.accessToken;
        // The signed-in user info.
        const user = result.user;
        // IdP data available using getAdditionalUserInfo(result)
        // ...
      }).catch((error) => {
        // Handle Errors here.
        const errorCode = error.code;
        const errorMessage = error.message;
        // The email of the user's account used.
        const email = error.customData.email;
        // The AuthCredential type that was used.
        const credential = GoogleAuthProvider.credentialFromError(error);
        // ...
      });
      }
      });

      function signout(){
        auth.signOut()
        document.getElementById("profile").innerHTML = ""
      }
      window.signout = signout;


      function writeUserData() {
        if (badName()){name="Guest"}
        set(ref(database, 'users/'+name), {
          highscore: highscore,
          dateJoined: Date()
        });
      }
      function writeSessionData (){
        if (badName()){name="Guest"}else{name=getCookie("name")}
        push(ref(database, 'sessions/'), {
          name: user.displayName,
          uid: user.uid,
          score:score,
          datePlayed: Date(),
          averageLetterSpeed: (sum/averages.length).toFixed(3),
        });
      }
      function updateHighscore() {
        if (badName()){name="Guest"}
        const userRef = ref(database, 'users/' + name);
        // Use the update function to update the highscore property
        // TODO replace set with update
        set(userRef, {
          highscore: highscore
        }, { merge: true });
      }

window.writeSessionData = writeSessionData;
window.updateHighscore = updateHighscore;


function pullData() {
  const dbRef = ref(database);
  onValue(dbRef, (snapshot) => { 
    const data = snapshot.val();
    console.log(data['users'])


    //TODO: change so that name is 
    // Convert the data object to an array of objects
    // const dataArray = Object.entries(data['users']).map(([name, values]) => ({ name, highscore: values.highscore }));
    const dataArray = Object.entries(data['users']).map(([id, values]) => ({ id, name: values.name, photo: values.photo, highscore: values.highscore }));
    console.log(dataArray)

    console.log("PULLED DATA")  
    // Sort the array based on highscores
    dataArray.sort((a, b) => b.highscore - a.highscore);

    const leaderboard = document.getElementById('leaderboard');
    leaderboard.innerHTML = '';

    // Create a table element with Bootstrap classes
    const table = document.createElement('table');
    table.classList.add('table', 'table-striped', 'table-hover', 'table-primary');

    // Create the table header row
    const thead = document.createElement('thead');
    thead.classList.add('thead-dark');
    const headerRow = document.createElement('tr');
    const headers = ['Ranking', "Player", 'Highscore'];

    headers.forEach(headerText => {
      const th = document.createElement('th');
      th.textContent = headerText;
      headerRow.appendChild(th);
    });

    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Create the table body
    const tbody = document.createElement('tbody');
    tbody.classList.add('text-success');

    // Iterate over the sorted array and add rows to the table body
    dataArray.forEach((item, index) => {
      const { name, highscore, photo } = item;

      const row = document.createElement('tr');

      // Create columns for ranking, name, and highscore
      const rankingCol = document.createElement('td');
      rankingCol.classList.add('font-weight-bold');
      rankingCol.textContent = index + 1;
      if (index === 0) {rankingCol.innerHTML += ' üèÜ';}
      if (index === 1) {rankingCol.innerHTML += 'ü•à';}
      if (index === 2) {rankingCol.innerHTML += 'ü•â';}
      const nameCol = document.createElement('td'); nameCol.innerHTML = "<img src='"+photo+"' style='height: 5vh; border-radius: 50% '> "+name;
      const highscoreCol = document.createElement('td'); highscoreCol.textContent = highscore;

      // For the player's name, highlight in green, and add "You are ranked #" msg
      if (nameCol.innerText == getCookie("name")) {
        row.classList.add('table-info');
        document.getElementById('lbtitle2').innerText='You are ranked #'+rankingCol.innerText
      }
      // Append columns to the row
      row.appendChild(rankingCol);
      row.appendChild(nameCol);
      row.appendChild(highscoreCol);
      // Append the row to the table body
      tbody.appendChild(row);
    });
    table.appendChild(tbody);
    // Append the table to the modal footer
    leaderboard.appendChild(table);
  });
}

pullData()


if (badName()){
  name=prompt("Enter your FULL name \nThis name cannot be changed!\nThis name will be used for the leaderboard")
  document.cookie = "name="+name
  if (badName()){document.cookie = "name=Guest"; name="Guest"}

  if (badName()==false){
    writeUserData()
  }
}
</script>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <a class="navbar-brand" style="color: white;"><img src="logo.png" style="height: 8vh; padding: 2vh;" >Type-Righter</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
<button class="btn-light" style="margin: 0.1rem 0.2rem;border-radius: 0.2rem; padding: 1vh;" onclick="document.getElementById('settingsmodal').style.display='block'"><img src="settings.png" style="width: 3vh;"></button>
<button class="btn-info" style="margin: 0.1rem 0.2rem;border-radius: 0.2rem;;" onclick="modal.style.display='block'; console.log(score);">‚ùì</button>
<button class="btn-success" style="margin: 0.1rem 0.2rem;border-radius: 0.2rem;" id="pauser" onclick="pauseButton(); keyPressed()"></button>
<button class="btn-warning" style="margin: 0.1rem 0.2rem;border-radius: 0.2rem;" onclick="document.getElementById('leaderboardmodal').style.display='block'; if (document.getElementById('leaderboard').innerHTML==''){document.getElementById('lbtitle2').innerHTML='Please check your internet connection'}">üèÜ</button>
<li>
  <h6 id="profile" style="color: white; background-color: green; border-radius: 2vh; padding: 1vh;"></h6>
</li>
<button id="logout" onclick="signout()">Sign Out</button>
</ul></div></nav>



  <center id="p5canvas"><div id="canvas-container" style="border:0.1rem solid #000000;"></div></center>
<div id="keyboard">
  <div class="row">
    <button class="key">ÿ∞</button>
    <button class="key">1</button>
    <button class="key">2</button>
    <button class="key">3</button>
    <button class="key">4</button>
    <button class="key">5</button>
    <button class="key">6</button>
    <button class="key">7</button>
    <button class="key">8</button>
    <button class="key">9</button>
    <button class="key">0</button>
    <button class="key">-</button>
    <button class="key">=</button>
    <button class="key">Backspace</button>
  </div>

  <div class="row">
    <button class="key">Tab</button>
    <button class="key">ÿ∂</button>
    <button class="key">ÿµ</button>
    <button class="key">ÿ´</button>
    <button class="key">ŸÇ</button>
    <button class="key">ŸÅ</button>
    <button class="key">ÿ∫</button>
    <button class="key">ÿπ</button>
    <button class="key">Ÿá</button>
    <button class="key">ÿÆ</button>
    <button class="key">ÿ≠</button>
    <button class="key">ÿ¨</button>
    <button class="key">ÿØ</button>
    <button class="key">\</button>
  </div>

  <div class="row">
    <button class="key">Caps Lock</button>
    <button class="key">ÿ¥</button>
    <button class="key">ÿ≥</button>
    <button class="key">Ÿä</button>
    <button class="key">ÿ®</button>
    <button class="key">ŸÑ</button>
    <button class="key">ÿß</button>
    <button class="key">ÿ™</button>
    <button class="key">ŸÜ</button>
    <button class="key">ŸÖ</button>
    <button class="key">ŸÉ</button>
    <button class="key">ÿ∑</button>
    <button class="key">Enter</button>
  </div>

  <div class="row">
    <button class="key">Shift</button>
    <button class="key">ÿ¶</button>
    <button class="key">ÿ°</button>
    <button class="key">ÿ§</button>
    <button class="key">ÿ±</button>    
    <button class="key">ŸÑÿß</button>
    <button class="key">Ÿâ</button>
    <button class="key">ÿ©</button>
    <button class="key">Ÿà</button>
    <button class="key">ÿ≤</button>
    <button class="key">ÿ∏</button>
    <button class="key">Shift</button>
  </div>
</div>


<div id="leaderboardmodal" class="modal" style="overflow-y: auto; font-family: 'Audiowide';">
  <div class="modal-content" style="width: 75%; background-image: url('/asal_assets/bg-downsized.jpg'); background-size: 10%;">
    <div class="modal-header">
      <center><h2 style='align-self: center;'>Leaderboard</h2></center>
      <h3 id="lbtitle2"></h3>
      <span style="cursor:pointer;" onclick="document.getElementById('leaderboardmodal').style.display='none'">&times;</span></div>
  <div class="modal-body" id="leaderboard"></div>
</div>
</div>

<div id="gameovermodal" class="modal" >
  <div class="modal-content" style="width: 45%; font-family: 'Audiowide';">
    <div class="modal-header">
      <h2 style='align-self: center;'><center>Game Over</center></h2>
      <span style="cursor:pointer;" onclick="document.getElementById('gameovermodal').style.display='none'">&times;</span></div>
  <div class="modal-body" id="gameoverbody"></div>
</div>
</div>

<div id="settingsmodal" class="modal">
  <div class="modal-content" style="width: 75%;">
<div>
  <span style="cursor:pointer; padding: 0.5rem;" onclick="document.getElementById('settingsmodal').style.display='none'">&times;</span>
</div>
  <div class="modal-body">
    <div id="settings"><center>
      <button id="fxmuter" class="key" onclick="fxmuteButton()" style="display: inline;"></button>
      <button id="muter" class="key" onclick="muteButton()" style="display: inline;"></button>
      <button id="keyboarder" class="key" style="display: inline;" onclick="document.getElementById('keyboard').hidden = !document.getElementById('keyboard').hidden;"> Keyboard ‚å®</button>
      <button class="key" style="display: inline;" id="hinter" onclick="hintsButton()">Hinting On</button></center>
    </div>
  </div>
</div>
</div>

<!-- Trigger/Open The Modal -->
<div id="myModal" class="modal">
  <!-- Modal content -->
   <div class="modal-content" style="width: 80%;">
    <div id = "ModalHeaderDiv" class="modal-header">
      <center><h2 style='align-self: center;' id="Modal Header">Type to win!</h2></center>
      <span class="close">&times;</span></div>
    <div class="modal-body">
      <h2 style="text-align: center;">Type the falling Arabic letters!<br>Don't let the keys reach the bottom of the screen!</h2>
      <li>English keyboard can also be used with most keyboard layouts</li>
      <li>Use space to pause and resume</li>
      <li>Users with different keyboard layouts should switch to Arabic keyboard for best results</li>
      <li>This site uses cookies and other methods to collect data to optimize your user experience</li>
      <li>This game is still in development</li>
    </div>
    <div id = "ModalFooterDiv" class="modal-footer">
      <h3 id="Modal Footer">Brought to you by <a style="color: purple;" href="https:kawakibcreations.net" >Kawakib Creations</a></h3>
    </div>
  </div>
</div>
<script src="sketch.js" type="text/javascript"></script>
</body>

        


<script> // Get the modal
  var modal = document.getElementById("myModal");
  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[0];//close modal when x clicked
  span.onclick = function() {
    modal.style.display = "none";
 //     firsthint()
  }
  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }
  modal.style.display="block"
  
  document.addEventListener('keydown', function(event) {
      if (event.keyCode == 32) {
          pauseButton();
      }
  });
  </script>
</html>
