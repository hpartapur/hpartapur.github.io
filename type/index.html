<!DOCTYPE html>
<!-- TODO: Figure out how to set a timer -->
<!-- ratios-keyboard  -->
<!-- put profile between rank and name -->
<html>
  <head>
    <meta name="google-adsense-account" content="ca-pub-7620239072665997">
    <meta charset="UTF-8">
    <title>Khardal Typist</title>
    <script src="libraries/p5.min.js" type="text/javascript"></script>
    <script src="libraries/p5.sound.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href = "style.css">
    <!-- <script src="sketch.js" type="text/javascript"></script> -->
    <!-- Add Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Audiowide">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZJM8TVT5H6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZJM8TVT5H6');
    </script>
  </head>

  <body>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-analytics.js";
      import { getDatabase, ref, push, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
    
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyCwcVRnXVs5M8EWEipwRgBREInAMgvj36s",
        authDomain: "khardal-typist.firebaseapp.com",
        databaseURL: "https://khardal-typist-default-rtdb.firebaseio.com",
        projectId: "khardal-typist",
        storageBucket: "khardal-typist.appspot.com",
        messagingSenderId: "277127524840",
        appId: "1:277127524840:web:c94fb2984ae4b694afb45d",
        measurementId: "G-JK8X82LLSX"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      window.database = getDatabase(app);


      function writeUserData() {
        if (badName()){name="Guest"}
        set(ref(database, 'users/'+name), {
          highscore: highscore,
          dateJoined: Date()
        });
      }
      function writeSessionData (){
        if (badName()){name="Guest"}
        push(ref(database, 'sessions/'), {
          name: name,
          score:score,
          datePlayed: Date()
        });
      }
      function updateHighscore() {
        if (badName()){name="Guest"}
        const userRef = ref(database, 'users/' + getCookie('name'));
        // Use the update function to update the highscore property
        set(userRef, {
          highscore: highscore
        }, { merge: true });
      }

window.writeSessionData = writeSessionData;
window.updateHighscore = updateHighscore;

function pullData() {
  const dbRef = ref(database);
  onValue(dbRef, (snapshot) => {
    const data = snapshot.val();
    console.log(data['users'])

    // Convert the data object to an array of objects
    const dataArray = Object.entries(data['users']).map(([name, values]) => ({ name, highscore: values.highscore }));
    // Sort the array based on highscores
    dataArray.sort((a, b) => b.highscore - a.highscore);

    // Get the leaderboard div
    const leaderboard = document.getElementById('leaderboard');
    leaderboard.innerHTML = '';

    // Create a table element with Bootstrap classes
    const table = document.createElement('table');
    table.classList.add('table', 'table-striped', 'table-hover', 'table-primary');

    // Create the table header row
    const thead = document.createElement('thead');
    thead.classList.add('thead-dark');
    const headerRow = document.createElement('tr');
    const headers = ['Ranking', 'Name', 'Highscore'];

    headers.forEach(headerText => {
      const th = document.createElement('th');
      th.textContent = headerText;
      headerRow.appendChild(th);
    });

    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Create the table body
    const tbody = document.createElement('tbody');
    tbody.classList.add('text-success');

    // Iterate over the sorted array and add rows to the table body
    dataArray.forEach((item, index) => {
      const { name, highscore } = item;

      const row = document.createElement('tr');

      // Create columns for ranking, name, and highscore
      const rankingCol = document.createElement('td');
      rankingCol.classList.add('font-weight-bold');
      rankingCol.textContent = index + 1;
      if (index === 0) {rankingCol.innerHTML += ' üèÜ';}
      if (index === 1) {rankingCol.innerHTML += 'ü•à';}
      if (index === 2) {rankingCol.innerHTML += 'ü•â';}

      const nameCol = document.createElement('td');
      nameCol.textContent = name;
      
      const highscoreCol = document.createElement('td');
      highscoreCol.textContent = highscore;

      if (nameCol.innerText == getCookie("name")) {
        row.classList.add('table-info');
      }

      // Append columns to the row
      row.appendChild(rankingCol);
      row.appendChild(nameCol);
      row.appendChild(highscoreCol);

      // Append the row to the table body
      tbody.appendChild(row);
    });

    table.appendChild(tbody);

    // Append the table to the modal footer
    leaderboard.appendChild(table);
  });
}

pullData()


if (badName()){
  name=prompt("Enter your name \nThis name cannot be changed!")
  document.cookie = "name="+name

  if (badName()==false){
    writeUserData()
  }
}
</script>

  <center id="p5canvas"><div id="canvas-container" style="border:0.1rem solid #000000;"></div></center>

<div id="keyboard">
  <div class="row">
    <button class="key">ÿ∞</button>
    <button class="key">1</button>
    <button class="key">2</button>
    <button class="key">3</button>
    <button class="key">4</button>
    <button class="key">5</button>
    <button class="key">6</button>
    <button class="key">7</button>
    <button class="key">8</button>
    <button class="key">9</button>
    <button class="key">0</button>
    <button class="key">-</button>
    <button class="key">=</button>
    <button class="key">Backspace</button>
  </div>

  <div class="row">
    <button class="key">Tab</button>
    <button class="key">ÿ∂</button>
    <button class="key">ÿµ</button>
    <button class="key">ÿ´</button>
    <button class="key">ŸÇ</button>
    <button class="key">ŸÅ</button>
    <button class="key">ÿ∫</button>
    <button class="key">ÿπ</button>
    <button class="key">Ÿá</button>
    <button class="key">ÿÆ</button>
    <button class="key">ÿ≠</button>
    <button class="key">ÿ¨</button>
    <button class="key">ÿØ</button>
    <button class="key">\</button>
  </div>

  <div class="row">
    <button class="key">Caps Lock</button>
    <button class="key">ÿ¥</button>
    <button class="key">ÿ≥</button>
    <button class="key">Ÿä</button>
    <button class="key">ÿ®</button>
    <button class="key">ŸÑ</button>
    <button class="key">ÿß</button>
    <button class="key">ÿ™</button>
    <button class="key">ŸÜ</button>
    <button class="key">ŸÖ</button>
    <button class="key">ŸÉ</button>
    <button class="key">ÿ∑</button>
    <button class="key">Enter</button>
  </div>

  <div class="row">
    <button class="key">Shift</button>
    <button class="key">ÿ¶</button>
    <button class="key">ÿ°</button>
    <button class="key">ÿ§</button>
    <button class="key">ÿ±</button>    
    <button class="key">ŸÑÿß</button>
    <button class="key">Ÿâ</button>
    <button class="key">ÿ©</button>
    <button class="key">Ÿà</button>
    <button class="key">ÿ≤</button>
    <button class="key">ÿ∏</button>
    <button class="key">Shift</button>
  </div>
</div>

<button class="key" style="display: inline; float: inline-start;" onclick="document.getElementById('settingsmodal').style.display='block'">‚öô</button>
<button class="key" style="display: inline; float: inline-end;" onclick="modal.style.display='block'; console.log(score);">‚ùì</button>
<button class="key" style="display: inline; float: inline-start;" id="pauser" onclick="pauseButton(); keyPressed()"></button>
<button class="key" style="display: inline; float: inline-end;" onclick="document.getElementById('leaderboardmodal').style.display='block'">üèÜ</button>



<div id="leaderboardmodal" class="modal" style="overflow-y: auto; font-family: 'Audiowide';">
  <div class="modal-content" style="width: 75%; background-image: url('/asal_assets/bg-downsized.jpg'); background-size: 10%;">
    <div class="modal-header">
      <center><h2 style='align-self: center;'>Leaderboard</h2></center>
      <span style="cursor:pointer;" onclick="document.getElementById('leaderboardmodal').style.display='none'">&times;</span></div>
  <div class="modal-body" id="leaderboard"></div>
</div>
</div>

<div id="gameovermodal" class="modal" >
  <div class="modal-content" style="width: 45%; font-family: 'Audiowide';">
    <div class="modal-header">
      <h2 style='align-self: center;'><center>Game Over</center></h2>
      <span style="cursor:pointer;" onclick="document.getElementById('gameovermodal').style.display='none'">&times;</span></div>
  <div class="modal-body" id="gameoverbody"></div>
</div>
</div>

<div id="settingsmodal" class="modal">
  <div class="modal-content" style="width: 75%;">
<div>
  <span style="cursor:pointer; padding: 0.5rem;" onclick="document.getElementById('settingsmodal').style.display='none'">&times;</span>
</div>
  <div class="modal-body">
    <div id="settings"><center>
      <button id="fxmuter" class="key" onclick="fxmuteButton()" style="display: inline;"></button>
      <button id="muter" class="key" onclick="muteButton()" style="display: inline;"></button>
      <button id="keyboarder" class="key" style="display: inline;" onclick="document.getElementById('keyboard').hidden = !document.getElementById('keyboard').hidden;"> Keyboard ‚å®</button>
      <button class="key" style="display: inline;" id="hinter" onclick="hintsButton()">Hinting On</button></center>
    </div>
  </div>
</div>
</div>


<!-- Trigger/Open The Modal -->
<div id="myModal" class="modal">
  <!-- Modal content -->
   <div class="modal-content" style="width: 80%;">
    <div id = "ModalHeaderDiv" class="modal-header">
      <center><h2 style='align-self: center;' id="Modal Header">Type to win!</h2></center>
      <span class="close">&times;</span></div>
    <div class="modal-body">
      <h2 style="text-align: center;">Type the falling Arabic letters!<br>Don't let the keys reach the bottom of the screen!</h2>
      <li>English keyboard can also be used with most keyboard layouts</li>
      <li>Use space to pause and resume</li>
      <li>Users with different keyboard layouts should switch to Arabic keyboard for best results</li>
      <li>This site uses cookies and other methods to collect data to optimize your user experience</li>
      <li>This game is still in development</li>
    </div>
    <div id = "ModalFooterDiv" class="modal-footer">
      <h3 id="Modal Footer">Brought to you by <a style="color: purple;" href="https:kawakibcreations.net" >Kawakib Creations</a></h3>
    </div>
  </div>
</div>
<script src="sketch.js" type="text/javascript"></script>
</body>

        


<script> // Get the modal
  var modal = document.getElementById("myModal");
  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[0];//close modal when x clicked
  span.onclick = function() {
    modal.style.display = "none";
 //     firsthint()
  }
  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }
  modal.style.display="block"
  
  document.addEventListener('keydown', function(event) {
      if (event.keyCode == 32) {
          pauseButton();
      }
  });
  </script>

</html>
