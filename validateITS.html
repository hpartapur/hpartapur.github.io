<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>8-Digit ID Validator with Excel Upload</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
		<!-- Add the xlsx library -->

		<script>
			// Global variable to hold counts and IDs for each category
			let categoryData = {
				"Taheri Mohallah": [],
				Doctors: [],
				Talabat: [],
				Talebat: [],
				FollowUp: [],
				Yemen: [],
			};

			// Variable to temporarily store valid IDs before adding them to the breakdown
			let validIds = [];

			// Disable input fields until a category is selected
			function toggleInput() {
				const selectedCategory = document.querySelector('input[name="category"]:checked');
				const inputBox = document.getElementById("inputText");
				const fileInput = document.getElementById("fileInput");
				const addToBreakdownButton = document.getElementById("addToBreakdownButton");

				if (selectedCategory) {
					inputBox.disabled = false;
					fileInput.disabled = false;
					addToBreakdownButton.disabled = false;
				} else {
					inputBox.disabled = true;
					fileInput.disabled = true;
					addToBreakdownButton.disabled = true;
				}
			}

			// Validate the IDs from the input box
			function validateIdsFromInput() {
				let inputText = document.getElementById("inputText").value;
				let regex = /\b\d{8}\b/g;
				let ids = inputText.match(regex);

				validIds = []; // Clear previous valid IDs

				// Extract valid IDs from the input text
				if (ids) {
					validIds = validIds.concat(ids);
				}

				// Update the displayed valid IDs and the count
				displayValidIds();
			}

			// Validate the IDs from the uploaded file
			function validateIdsFromFile(file) {
				let reader = new FileReader();
				reader.onload = function (e) {
					let data = e.target.result;
					let workbook = XLSX.read(data, { type: "binary" });
					let sheet = workbook.Sheets[workbook.SheetNames[0]]; // Read the first sheet
					let text = XLSX.utils.sheet_to_csv(sheet); // Convert sheet to CSV text format

					// Extract 8-digit IDs from the converted text
					let idsFromText = text.match(/\b\d{8}\b/g);

					validIds = []; // Clear previous valid IDs

					if (idsFromText) {
						validIds = validIds.concat(idsFromText);
					}

					// Update the displayed valid IDs and the count
					displayValidIds();
				};
				reader.readAsBinaryString(file);
			}

			// Display the valid IDs and the count below
			function displayValidIds() {
				let displayArea = document.getElementById("validIdsDisplay");
				displayArea.innerHTML = "<strong>Valid 8-Digit IDs:</strong><br>" + validIds.join("<br>");
				document.getElementById("validIdsCount").innerText = "Count: " + validIds.length;
			}

			// Add valid IDs to the selected category in the breakdown
			function addToBreakdown() {
				// Get the selected category
				let selectedCategory = document.querySelector('input[name="category"]:checked').value;

				// Add the valid IDs to the selected category
				categoryData[selectedCategory] = categoryData[selectedCategory].concat(validIds);

				// Clear the valid IDs list, input text, and file input
				validIds = [];
				document.getElementById("inputText").value = "";
				document.getElementById("fileInput").value = "";

				// Deselect the radio button and reset category selection
				let selectedRadio = document.querySelector('input[name="category"]:checked');
				if (selectedRadio) selectedRadio.checked = false;

				// Update the category table with counts
				updateCategoryTable();

				// Clear the valid IDs display
				document.getElementById("validIdsDisplay").innerHTML = "";
				document.getElementById("validIdsCount").innerText = "Count: 0";

				// Disable input fields after adding to breakdown
				toggleInput();
			}

			// Update the table with category counts
			function updateCategoryTable() {
				let tableBody = document.getElementById("categoryTableBody");
				tableBody.innerHTML = ""; // Clear previous table content

				for (let category in categoryData) {
					let row = document.createElement("tr");
					row.innerHTML = `<td>${category}</td><td>${categoryData[category].length}</td>`;
					tableBody.appendChild(row);
				}
			}

			// Copy all IDs, sorted by category, to the clipboard in the required format
			function copyToClipboard() {
				let outputText = "";

				for (let category in categoryData) {
					if (categoryData[category].length > 0) {
						outputText += `${category}\n${categoryData[category].join("\n")}\n\n`;
					}
				}

				// Create a temporary textarea to copy the generated text
				let tempTextArea = document.createElement("textarea");
				tempTextArea.value = outputText.trim();
				document.body.appendChild(tempTextArea);
				tempTextArea.select();
				document.execCommand("copy");
				document.body.removeChild(tempTextArea);

				alert("Copied to clipboard!");
			}

			// Function to handle file upload and read the Excel data
			function handleFileUpload(event) {
				let file = event.target.files[0];
				if (file && file.name.endsWith(".xlsx")) {
					validateIdsFromFile(file);
				} else {
					alert("Please upload a valid .xlsx file.");
				}
			}

			// Automatically validate when the user clicks out of the input box
			function onInputBlur() {
				validateIdsFromInput();
			}
		</script>
	</head>
	<body>
		<h1>8-Digit ID Validator with Excel Upload</h1>

		<!-- Radio buttons for category selection -->
		<h3>Select a Category:</h3>
		<label><input type="radio" name="category" value="Taheri Mohallah" onclick="toggleInput()" /> Taheri Mohallah</label><br />
		<label><input type="radio" name="category" value="Doctors" onclick="toggleInput()" /> Doctors</label><br />
		<label><input type="radio" name="category" value="Talabat" onclick="toggleInput()" /> Talabat</label><br />
		<label><input type="radio" name="category" value="Talebat" onclick="toggleInput()" /> Talebat</label><br />
		<label><input type="radio" name="category" value="FollowUp" onclick="toggleInput()" /> FollowUp</label><br />
		<label><input type="radio" name="category" value="Yemen" onclick="toggleInput()" /> Yemen</label><br /><br />

		<!-- File upload input for Excel file -->
		<input type="file" id="fileInput" accept=".xlsx" onchange="handleFileUpload(event)" disabled /><br /><br />

		<!-- Text area for manual input, disabled until a category is selected -->
		<textarea id="inputText" rows="6" cols="50" onblur="onInputBlur()" disabled></textarea><br /><br />

		<!-- Buttons to add to breakdown -->
		<button id="addToBreakdownButton" onclick="addToBreakdown()" disabled>Add to Breakdown</button><br /><br />

		<!-- Area to display the valid IDs and their count -->
		<div id="validIdsDisplay"></div>
		<div id="validIdsCount">Count: 0</div>

		<!-- Copy to clipboard button -->
		<button id="copyButton" style="display: none" onclick="copyToClipboard()">Copy to Clipboard</button>

		<br /><br />

		<!-- Table to display the category counts -->
		<h3>Category Counts:</h3>
		<table border="1">
			<thead>
				<tr>
					<th>Category</th>
					<th>Count of Valid IDs</th>
				</tr>
			</thead>
			<tbody id="categoryTableBody">
				<!-- Table rows will be populated dynamically -->
			</tbody>
		</table>
	</body>
</html>
