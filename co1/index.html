<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script src="https://cdn.lordicon.com/lordicon.js"></script>
		<link rel="icon" href="https://img.icons8.com/arcade/64/report-card.png" type="image/x-icon" />
		<link rel="manifest" href="/co1/manifest.json">
		<title>Home - Collegiate 1 Awraq</title>
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
		/>
		<style>
			.material-symbols-outlined {
				font-variation-settings: "FILL" 0, "wght" 300, "GRAD" 0, "opsz" 48;
				font-size: 80px;
			}
		</style>
	</head>
	<body>
		<nav style="background-color: #333; color: white; padding: 10px">
			<div class="user-info">
				<img id="user-photo" hidden class="user-photo" src="" alt="User Photo" />
				<p id="user-name" hidden class="user-name"></p>
				<p id="user-email" hidden class="user-email"></p>
			</div>
			<h1 style="color: white; text-align: center; margin: 0">Awraq ul Murajaat - Home</h1>
		</nav>
		<div class="container">
			<h1>Teacher Marks Entry - Home</h1>

			<div id="global-message-area"></div>

			<div class="auth-container">
				<button id="sign-in-button" class="auth-button">
					<!-- <span class="material-symbols-outlined"> lock_open</span> -->
					<lord-icon
						src="https://cdn.lordicon.com/eziplgef.json"
						trigger="loop"
						delay="1000"
						state="hover-draw"
						style="width:4rem;height:4rem">
					</lord-icon>
					<br>Sign In</button>
				<div id="user-section" class="hidden">
					<div class="user-info">
						<button id="admin-access" class="auth-button orange-button admin">
							<!-- <span class="material-symbols-outlined"> shield_person </span> -->
							<lord-icon
								src="https://cdn.lordicon.com/vpbspaec.json"
								trigger="loop"
								colors="primary:white,secondary:white"
								stroke="bold"
								style="width:4rem;height:4rem">
							</lord-icon>
							<br />Admin Access
						</button>
						<button id="admin-entry" class="auth-button purple-button admin">
							<!-- <span class="material-symbols-outlined"> edit_note </span> -->
							<lord-icon
								src="https://cdn.lordicon.com/igcctxvk.json"
								trigger="loop"
								colors="primary:white,secondary:white"
								stroke="bold"
								style="width:4rem;height:4rem">
							</lord-icon>
							<br />Admin Entry
						</button>
						<button id="admin-reports" class="auth-button green-button admin">
							<!-- <span class="material-symbols-outlined"> analytics </span> -->
							<lord-icon
								src="https://cdn.lordicon.com/oqhqyeud.json"
								trigger="loop"
								colors="primary:white,secondary:white"
								stroke="bold"
								style="width:4rem;height:4rem">
							</lord-icon>
							<br />Admin Reports
						</button>

						<button id="entry" class="auth-button yellow-button">
						<!-- <span class="material-symbols-outlined"> assignment_turned_in </span> -->
							<lord-icon
								src="https://cdn.lordicon.com/knfutiyr.json"
								trigger="loop"
								colors="primary:white,secondary:white"
								stroke="bold"
								style="width:4rem;height:4rem">
							</lord-icon>
						<br />Marks Entry
						</button>
						<button id="masool" class="auth-button brown-button" hidden>
							<!-- <span class="material-symbols-outlined"> museum </span> -->
								<lord-icon
									src="https://cdn.lordicon.com/cfoaotmk.json"
									trigger="loop"
									colors="primary:white,secondary:white"
									stroke="bold"
									style="width:4rem;height:4rem">
								</lord-icon>
							<br />Masool Portal
							</button>
					</div>
					<button id="sign-out-button" class="auth-button"><span class="material-symbols-outlined"> logout </span><br />Sign Out</button>

					<div id="stats-cards">
						<div id="assessments-card" class="card" style="background-color: lightgoldenrodyellow">
							<p>My Assessments</p>
							<br />
							<lord-icon
							src="https://cdn.lordicon.com/fikcyfpp.json"
							trigger="loop"
							colors="primary:#242424,secondary:grey"
							style="width:4rem;height:4rem">
						</lord-icon>
							<br />
							<span id="assessments-count">0</span>
						</div>
						<div id="marks-card" class="card" style="background-color: #92d6d6">
							<p>Marks Filled</p>
							<br />
							<lord-icon
							src="https://cdn.lordicon.com/edcgvlnw.json"
							trigger="loop"
							colors="primary:#242424,secondary:grey"
							style="width:4rem;height:4rem">
						</lord-icon>
							<br />
							<span id="marks-count">0</span>
					</div>
					<div id="'pending-card" class="card" style="background-color: lightpink">
						<p>Pending Entry</p>
						<br />
						<lord-icon
							src="https://cdn.lordicon.com/exymduqj.json"
							trigger="loop"
							colors="primary:#121331,secondary:#e83a30"
							style="width:4rem;height:4rem">
						</lord-icon>
						<br />
						<span id="pending-count">0</span>
					</div>
					<div id="percentage-card" class="card" style="background-color: #f5ba5b">
						<p>Percentage Entered</p>
						<br />
						<lord-icon
							src="https://cdn.lordicon.com/dkobpcrm.json"
							trigger="loop"
							colors="primary:#121331,secondary:#e83a30"
							style="width:4rem;height:4rem">
						</lord-icon>
						<br />
						<span id="percentage-count">0%</span>
					</div>
					<div id="average-card" class="card" style="background-color: #daa3de">
						<p>Average Score</p>
						<br />
						<lord-icon
							src="https://cdn.lordicon.com/bduzytli.json"
							trigger="loop"
							colors="primary:#121331,secondary:#e83a30"
							style="width:4rem;height:4rem">
						</lord-icon>
						<br />
						<span id="average-count">0</span>
					</div>
					<table id="assessments-table" class="hidden">
						<caption>
							My Assessments
						</caption>
						<thead>
							<tr>
								<th>Name</th>
								<th>Filled</th>
								<th>Total</th>
							</tr>
						</thead>
						<tbody id="assessments-body"></tbody>
					</table>
				</div>
			</div>


			<div id="app-content" class="hidden">
				<h2>Welcome to the Teacher Marks Entry System!</h2>
				<p>Once you're signed in, you can start managing assessments and marks.</p>
			</div>
		</div>

		<script>
			// --- DOM Elements ---
			const signInButton = document.getElementById("sign-in-button");
			const signOutButton = document.getElementById("sign-out-button");
			const userSection = document.getElementById("user-section");
			const userEmailSpan = document.getElementById("user-email");
			const userNameSpan = document.getElementById("user-name");
			const userPhotoImg = document.getElementById("user-photo");
			const appContent = document.getElementById("app-content");
			const globalMessageArea = document.getElementById("global-message-area");
			const entryButton = document.getElementById("entry");
			const assessmentsTable = document.getElementById("assessments-table");
			const assessmentsBody = document.getElementById("assessments-body");

			// --- Supabase Initialization ---
			const supabaseUrl = "https://urlburhufcpkpfcoyflh.supabase.co";
			const supabaseKey =
				"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVybGJ1cmh1ZmNwa3BmY295ZmxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwMzY1MzYsImV4cCI6MjA2MTYxMjUzNn0.17VTbejLDJyI9hkHPiuoiy5jcZmLdgiJ16GuhkiOd08";
			var supabase = supabase.createClient(supabaseUrl, supabaseKey);

			// --- Authentication Functions ---
			async function signInWithGoogle() {
				const { error } = await supabase.auth.signInWithOAuth({
					provider: "google",
					options: {
						redirectTo: "https://khardal.net/co1/", // Redirect to home page after sign-in
						// prompt: "select_account",
					},
				});
				if (error) {
					console.error("Error signing in:", error);
					showMessage(`Error signing in: ${error.message}`, "error");
				}
			}

			async function signOut() {
				const session = await supabase.auth.getSession();
				console.log("Session:", session);
				const { error } = await supabase.auth.signOut();
				if (error) {
					console.error("Error signing out:", error);
					showMessage(`Error signing out: ${error.message}`, "error");
				} else {
					updateUI(null); // Refresh UI after sign-out
				}
			}

			// --- UI Update Function ---
			async function updateUI(user) {
				clearMessage(); // Clear global messages on auth change

				if (user) {
					userNameSpan.textContent = user.user_metadata?.full_name || "User";
					userEmailSpan.textContent = user.email;
					userPhotoImg.src = user.user_metadata?.avatar_url || "https://www.example.com/default-avatar.jpg";

					signInButton.classList.add("hidden");
					userSection.classList.remove("hidden");
					appContent.classList.remove("hidden");

					// Change sign-out button color to red
					signOutButton.classList.add("red-button");
					signInButton.classList.remove("blue-button");

					getMasool(user.email);

					const { data, error } = await supabase.from("Teachers").select("*").eq("Email", user.email).single();
					const teacherid = data?.TeacherID;
					if (teacherid) {
						console.log("Teacher ID:", teacherid);
						entryButton.addEventListener("click", () => {
							window.location.href = `entry.html`;
						});
						assessmentsTable.classList.remove("hidden");
						getAssessments(teacherid);

						entryButton.classList.remove("hidden");
						entryButton.color = "red"; // Set background color to blue

						getMarkingProgress(teacherid);
					}

					const { data: admin, error: adminError } = await supabase.from("Admins").select("*").eq("Email", user.email).single();
					console.log("Admin Data:", admin.id);
					if (admin.id) {
						let adminElements = document.querySelectorAll(".admin");
						adminElements.forEach((element) => {
							element.style.display = "inline-block";
						});
						document.getElementById("admin-entry").addEventListener("click", () => {
							window.location.href = `admin-entry.html`;
						});
						document.getElementById("admin-access").addEventListener("click", () => {
							window.location.href = `admin.html`;
						});
						document.getElementById("admin-reports").addEventListener("click", () => {
							window.location.href = `reports.html`;
						});
					}
				} else {
					userNameSpan.textContent = "";
					userEmailSpan.textContent = "";
					userPhotoImg.src = "";
					signInButton.classList.remove("hidden");
					userSection.classList.add("hidden");
					appContent.classList.add("hidden");
					entryButton.classList.add("hidden");

					// Change sign-in button color to blue
					signInButton.classList.add("blue-button");
					signOutButton.classList.remove("red-button");
				}
			}
			async function getProgress(assessment) {
				const { data } = await supabase.from("Marks").select("*").eq("AssessmentID", assessment.id);
				console.log("Progress Data:", data);
				const row = document.createElement("tr");
				const cell = document.createElement("td");
				cell.textContent = assessment.Name;
				row.appendChild(cell);
				const filledCell = document.createElement("td");
				const notNull = data.filter((mark) => mark.MarksObtained !== null);
				let filled = notNull.length;
				let total = data.length;
				console.log("Filled:", filled, "Total:", total);
				filledCell.textContent = filled;
				row.appendChild(filledCell);
				const totalCell = document.createElement("td");
				totalCell.textContent = total;
				row.appendChild(totalCell);
				assessmentsBody.appendChild(row);
			}
			async function getMasool(email) {
				const { data, error } = await supabase.from("Classes").select("*").eq("Masool", email).single();
				if (error) {
					console.error("Error fetching masool. This user may not be a masool:", error);
					return;
				}
				document.getElementById("masool").hidden = false;
				document.getElementById("masool").addEventListener("click", () => {
					window.location.href = `masool.html`;
				});
			}

			async function getAssessments(teacherid) {
				const { data } = await supabase.from("Assessments").select("*").eq("TeacherID", teacherid);
				console.log("Assessments Data:", data);
				assessmentsBody.innerHTML = ""; // Clear previous entries
				if (data.length > 0) {
					data.forEach((assessment) => {
						getProgress(assessment);
					});
				} else {
					const row = document.createElement("tr");
					const cell = document.createElement("td");
					cell.textContent = "No assessments found.";
					row.appendChild(cell);
					assessmentsBody.appendChild(row);
				}
			}

			async function getMarkingProgress(teacherid) {
				console.log("Getting marking progress for teacher ID:", teacherid);
				const { data: assessments } = await supabase.from("Assessments").select("*").eq("TeacherID", teacherid);
				let { data: marks, error } = await supabase.from("Marks").select("*,Students(Name), Assessments(TeacherID,MaxMarks)");
				if (error) {
					console.error("Error fetching marks:", error);
					showMessage(`Error fetching marks: ${error.message}`, "error");
					return;
				}
				marks = marks.filter((mark) => mark.Assessments.TeacherID == teacherid);
				console.log("Marks Data:", marks);
				console.log("Assessment Count:", assessments);
				document.getElementById("assessments-count").textContent = assessments.length;
				let notNull = marks.filter((mark) => mark.MarksObtained !== null);
				document.getElementById("marks-count").textContent = notNull.length;
				let pending = marks.filter((mark) => mark.MarksObtained == null);
				document.getElementById("pending-count").textContent = pending.length;
				let total = marks.length;
				let percentage = ((notNull.length / total) * 100).toFixed(2);
				document.getElementById("percentage-count").textContent = percentage + "%";
				let scorepercentages = 0
				let notNulltotal = notNull.length;
				notNull.forEach((mark) => {
					console.log("Average",(mark.MarksObtained/ mark.Assessments.MaxMarks)*100);
					scorepercentages += (mark.MarksObtained / mark.Assessments.MaxMarks) * 100;
				});
				let average = (scorepercentages / notNulltotal).toFixed(2);
				document.getElementById("average-count").textContent = average + "%";
			}
			// --- Message Display ---
			function showMessage(message, type = "success") {
				globalMessageArea.textContent = message;
				globalMessageArea.className = `message-area message-${type}`;
				globalMessageArea.style.display = "block";
			}

			function clearMessage() {
				globalMessageArea.textContent = "";
				globalMessageArea.style.display = "none";
				globalMessageArea.className = "message-area";
			}

			// --- Event Listeners Setup ---
			signInButton.addEventListener("click", signInWithGoogle);
			signOutButton.addEventListener("click", signOut);

			// --- Auth State Change Listener ---
			supabase.auth.onAuthStateChange(async (event, session) => {
				const user = session?.user;
				console.log(user);
				updateUI(user); // Update UI when authentication state changes
			});
		</script>

		<style>
			body {
				font-family: Arial, sans-serif;
				background-color: #f4f7fa;
				margin: 0;
				padding: 0;
			}

			.container {
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				text-align: center;
			}

			h1 {
				color: #333;
				margin-bottom: 20px;
			}

			.auth-container {
				margin: 20px 0;
			}

			.auth-button {
				width: 9rem;
				height: 9rem;
				/* padding: 12px 25px; */
				margin: 10px;
				cursor: pointer;
				font-size: 1.2rem;
				border-radius: 5px;
				border: 0.5rem solid #0f0f0f;
			}

			.auth-button:hover {
				opacity: 0.9;
				transform: scale(1.1);
				transition: transform 0.2s;
			}

			.hidden {
				display: none;
			}

			.message-area {
				padding: 10px;
				margin-top: 20px;
				font-size: 16px;
				border-radius: 5px;
			}

			.message-success {
				background-color: #4caf50;
				color: white;
			}

			.message-error {
				background-color: #f44336;
				color: white;
			}

			.message-info {
				background-color: #2196f3;
				color: white;
			}

			.blue-button {
				background-color: #007bff;
				color: white;
				border: none;
			}

			.blue-button:hover {
				background-color: #0056b3;
			}

			.red-button {
				background-color: #f44336;
				color: white;
				border: none;
			}

			.red-button:hover {
				background-color: #d32f2f;
			}
			.yellow-button {
				background-color: #d9c511;
				color: white;
				border: none;
			}
			.yellow-button:hover {
				background-color: #fbc02d;
			}
			.orange-button {
				background-color: #ff9800;
				color: white;
				border: none;
			}
			.orange-button:hover {
				background-color: #f57c00;
			}
			.purple-button {
				background-color: #673ab7;
				color: white;
				border: none;
			}
			.purple-button:hover {
				background-color: #512da8;
			}
			.green-button {
				background-color: #4caf50;
				color: white;
				border: none;
			}
			.green-button:hover {
				background-color: #388e3c;
			}
			.brown-button {
				background-color: #795548;
				color: white;
				border: none;
			}
			.brown-button:hover {
				background-color: #5d4037;
			}

			/* User Info Section */
			.user-info {
				margin-top: 20px;
				display: inline-block;
				/* text-align: left; */
				align-items: center;
			}

			.user-photo {
				/* width: 60px; */
				height: 3rem;
				border-radius: 50%;
				/* margin-bottom: 10px; */
				/* display: inline-block; */
			}

			.user-name {
				font-weight: bold;
				font-size: 0.8rem;
				color: #696565;
				/* margin-bottom: 20px; */
				/* display: inline-block; */
			}

			.user-email {
				font-size: 0.5rem;
				color: #777;
			}
			table {
				margin: 20px auto;
				border-collapse: collapse;
				width: 100%;
			}
			th,
			td {
				border: 1px solid #ddd;
				padding: 8px;
				text-align: left;
			}
			th {
				background-color: #a98888;
				color: #333;
			}
			tr:nth-child(even) {
				background-color: #f9f9f9;
			}
			tr:hover {
				background-color: #ddd;
			}
			.admin {
				display: none;
				/* background-color: #673ab7; */
			}
			/* .admin:hover {
				background-color: #673ab7;
			} */
			.card {
				background-color: #fff;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				/* padding: 20px; */
				/* margin: 20px auto; */
				text-align: center;
				width: 10rem;
				height: 10rem;
				display: inline-block;
			}
			.card:hover {
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
				transition: box-shadow 0.3s;
				transform: scale(1.05);
			}
		</style>
	</body>
</html>
