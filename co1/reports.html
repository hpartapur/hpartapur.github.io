<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Reports - Collegiate 1 Awraq</title>
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
		<style>
			body {
				font-family: Arial, sans-serif;
				background-color: #f4f7fa;
				/* background-image: url("https://khardal.net/assets/bg.jpg"); */
				/* background-size: 13em; */
				margin: 0;
				padding: 0;
			}

            .dropdown {
                position: relative;
                display: block;
            }
            .dropdown-content {
                display: block;
                position: absolute;
                background-color: #f9f9f9;
                min-width: 160px;
                box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
                z-index: 1;
            }
            .dropdown-content option {
                color: black;
                padding: 12px 16px;
                text-decoration: none;
                display: block;
            }


			.container {
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				text-align: center;
			}

			h1 {
				color: #333;
				margin-bottom: 20px;
			}

			.auth-button {
				padding: 10px 20px;
				margin: 10px;
				font-size: 16px;
				border: none;
				border-radius: 5px;
				cursor: pointer;
			}

			.blue-button {
				background-color: #007bff;
				color: white;
			}

			.red-button {
				background-color: #f44336;
				color: white;
			}
			.green-button {
				background-color: #4CAF50;
				color: white;
			}
			.green-button:hover {
				background-color: #45a049;
			}

			.report-section {
				margin-top: 30px;
				text-align: left;
			}

			.report-section h2 {
				margin-bottom: 10px;
				color: #444;
			}

			table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 20px;
			}

			th,
			td {
				border: 1px solid #ddd;
				padding: 10px;
				text-align: left;
			}

			th {
				background-color: #f2f2f2;
			}

			.hidden {
				display: none;
			}
			caption {
				font-weight: bold;
				font-size: 1.2em;
				margin-bottom: 10px;
			}

		</style>
	</head>
	<body>

		<div class="container">
			<h1>ðŸ“Š Reports Dashboard</h1>
			<div id="global-message-area"></div>
			<div id="user-section" class="hidden">
				<p>Signed in as: <span id="user-email"></span></p>

				<div class="report-section">
					<h2>Available Reports</h2>
					<table id="assessments">
						<caption>
							Assessments
						</caption>
						<thead>
							<tr>
								<th>Week<input type="text" id="week-filter" placeholder="Filter by Week" /></th>
								<th>Class</th>
								<th>Assessment Title</th>
								<th>Teacher</th>
								<th>Progress</th>
								<th>Reminder Email</th>
                                <th>Reminder Whatsapp</th>
							</tr>
						</thead>
						<tbody></tbody>
					</table>

                    <!-- Dropdown -->
                     <br>
                    <select class="dropdown" id="class-dropdown">
                        <option value="">Select Class</option>
                        <div class="dropdown-content"></div>
                    </select>
                    <div>
                        <button onclick="exportMarks()" class=" auth-button red-button">Export Marks</button>
					<table id="marks-table">
						<caption>
							Marks
						</caption>
						<thead>
							<tr id="markstable-header">
								<th>Student</th>
							</tr>
						</thead>
						<tbody id="marks-table-body">
							<!-- Dynamic rows will go here -->
						</tbody>
					</table>


			</div>
		</div>

		<script>
			const userSection = document.getElementById("user-section");
			const userEmailSpan = document.getElementById("user-email");
			const reportOutput = document.getElementById("report-output");
			const reportTableBody = document.querySelector("#report-table tbody");
			const globalMessageArea = document.getElementById("global-message-area");

			const supabaseUrl = "https://urlburhufcpkpfcoyflh.supabase.co";
			const supabaseKey =
				"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVybGJ1cmh1ZmNwa3BmY295ZmxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwMzY1MzYsImV4cCI6MjA2MTYxMjUzNn0.17VTbejLDJyI9hkHPiuoiy5jcZmLdgiJ16GuhkiOd08";
			var supabase = supabase.createClient(supabaseUrl, supabaseKey);

			supabase.auth.onAuthStateChange((event, session) => {
				updateUI(session?.user);
			});

			function updateUI(user) {
				if (user) {
					userSection.classList.remove("hidden");
					userEmailSpan.textContent = user.email;
				} else {
					userSection.classList.add("hidden");
					userEmailSpan.textContent = "";
					reportOutput.classList.add("hidden");
				}
			}
            async function exportMarks() {
                const table = document.getElementById("marks-table");
                const workbook = XLSX.utils.table_to_book(table, { sheet: "Marks" });
                const fileName = `Awraq_${new Date().toISOString().split("T")[0]}.xlsx`;
                XLSX.writeFile(workbook, fileName);
                showMessage("Marks report exported successfully!", "success");
            }

			function showMessage(message, type = "success") {
				globalMessageArea.textContent = message;
				globalMessageArea.style.color = type === "error" ? "red" : "green";
			}


            async function populateClassDropdown() {
                const { data: classes, error } = await supabase
                    .from("Classes")
                    .select("*")

                if (error) {
                    showMessage("Error fetching classes: " + error.message, "error");
                    return;
                    
                }
                console.log(classes);
                const dropdown = document.querySelector(".dropdown-content");
                document.getElementById("class-dropdown").addEventListener("change", (event) => {
                    console.log(event.target.value);
                    getMarks(event.target.value);
                });
                dropdown.innerHTML = ""; // Clear existing options

                classes.forEach((classItem) => {
                    const option = document.createElement("option");
                    option.value = classItem.ClassID;
                    option.textContent = classItem.ClassID;
                    option.onselect = function () {
                        console.log(1)
                    };
                    dropdown.appendChild(option);
                });
            }
            populateClassDropdown(); // Call this function to populate the dropdown on page load

			async function getMarks(classID) {
				// classID = "6 A M";
				const { data: students, error: studentsError } = await supabase
					.from("Students")
					.select("TRNO, Name, ClassID, Classes(*)")
					.order("TRNO", { ascending: true });
				console.log(students);
				if (studentsError) {
					showMessage("Error fetching students: " + studentsError.message, "error");
					return;
				}
				let selectedStudents = students.filter((student) => student.ClassID === classID);
				console.log(selectedStudents);
				// const { data: assessments, error: assessmentsError } = await supabase.from("Assessments").select("*, Classes(*), Subjects(*)");
				// let selectedAssessments = assessments.filter((assessment) => assessment.Classes.Darajah === selectedDarajah);
				// console.log(selectedAssessments);
				const { data: marksData, error: marksError } = await supabase.from("Marks").select(`*, Assessments(*),Students(*)`);
				let selectedMarks = marksData.filter((mark) => mark.Students.ClassID === classID);
				console.log(selectedMarks);
				let assessmentids = [];
				let assessmentdata = {};
				selectedMarks.forEach((mark) => {
					assessmentids.push(mark.AssessmentID);
					assessmentdata[mark.AssessmentID] = mark.Assessments;
				});
				console.log(assessmentdata);
				assessmentids = [...new Set(assessmentids)];
				console.log(assessmentids);
				const tableHeader = document.getElementById("markstable-header");
				tableHeader.innerHTML = "<th>Student</th>";
				assessmentids.forEach((assessment) => {
					tableHeader.innerHTML += `<th>${assessmentdata[assessment].Name}</th>`;
				});
				const tableBody = document.getElementById("marks-table-body");
				tableBody.innerHTML = ""; // Clear existing rows
				selectedStudents.forEach((student) => {
					const row = document.createElement("tr");
					row.innerHTML = `<td>${student.Name}</td>`;
					selectedMarks.forEach((mark) => {
						if (mark.Students.TRNO === student.TRNO) {
							row.innerHTML += `<td>${mark.MarksObtained}</td>`;
						}
					});
					tableBody.appendChild(row);
				});
			}

            async function populateWeekDropdown() {
                
            }
			async function getProgress(assessment, marksData, row) {
				let total = 0;
				let notZero = 0;
				marksData.forEach((mark) => {
					if (mark.AssessmentID === assessment.id) {
						total++;
						if (mark.MarksObtained > 0) {
							notZero++;
						}
					}
				});
				const progress = (notZero / total) * 100;
				row.innerHTML += `<td>${progress.toFixed(2)}%</td>`;
				const assessmentsTableBody = document.querySelector("#assessments tbody");
				if (progress === 100) {
					row.style.backgroundColor = "#d4edda"; // Green for 100%
				} else if (progress >= 10) {
					row.style.backgroundColor = "#fff3cd"; // Yellow for 50% or more
				} else {
					row.style.backgroundColor = "#f8d7da"; // Red for less than 50%
				}
				row.innerHTML += `<td><a href="mailto:${assessment.Teachers.Email}?subject='Awraq${assessment.Name}'&body='This%20is%20a%20reminder%20to%20fill%20out%20marks%20for%20${assessment.Name}'"><button class='auth-button blue-button'>ðŸ“§Remind by Email</button></a></td>`;
                row.innerHTML += `<td><a href="https://wa.me/${assessment.Teachers.whatsapp}?text=This%20is%20a%20reminder%20to%20fill%20out%20marks%20for%20${assessment.Name}Login at khardal.net/co1"><button class='auth-button green-button'>ðŸ’¬Remind by Whatsapp</button></a></td>`;
				assessmentsTableBody.appendChild(row);
			}
			async function getAssessments() {
				const { data, error } = await supabase.from("Assessments").select(`*, Teachers(Name, Email,whatsapp)`).order("Week", { ascending: true }).order("ClassID", { ascending: true });
				console.log(data, error);
				const assessmentsTableBody = document.querySelector("#assessments tbody");
				assessmentsTableBody.innerHTML = ""; // Clear existing rows
				const marksData = await supabase.from("Marks").select("*");
				if (data) {
					data.forEach((assessment) => {
						const row = document.createElement("tr");
						row.innerHTML = `
			                         <td>${assessment.Week}</td>
			                         <td>${assessment.ClassID}</td>
			                         <td>${assessment.Name}</td>
			                         <td>${assessment.Teachers.Name}</td>
			                     `;
						let progress = getProgress(assessment, marksData.data, row);
					});
				} else {
					showMessage("No assessments found.", "error");
				}
			}
			getAssessments();
			getMarks("24653");
		function filterTable() {
        const weekFilter = document.getElementById("week-filter").value.toLowerCase();
        const rows = document.querySelectorAll("#assessments tbody tr");

        rows.forEach(row => {
          const week = row.cells[0].textContent.toLowerCase();
          // Show or hide row based on matching Week
          row.style.display = week.includes(weekFilter) ? "" : "none";
        });
      }

      // Add event listener to the Week filter input
      document.getElementById("week-filter").addEventListener("input", filterTable);
			// fetchReports();
		</script>
	</body>
</html>
