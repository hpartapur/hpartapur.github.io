<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>People Counter</title>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
		<style>
			canvas {
				position: absolute;
				top: 0;
				left: 0;
			}
		</style>
	</head>
	<body>
		<h1>People Counter: <span id="counter">0</span></h1>
		<video id="video" width="640" height="480" autoplay></video>
		<canvas id="canvas" width="640" height="480"></canvas>

		<script>
			const video = document.getElementById("video");
			const canvas = document.getElementById("canvas");
			const ctx = canvas.getContext("2d");
			let counter = 0;
			let lineY = 350;
			let peopleCrossed = new Set();

			// Start video stream
			navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
				video.srcObject = stream;
				video.play();
			});

			// Load the model
			cocoSsd.load().then((model) => {
				detect(model);
			});

			function detect(model) {
				ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
				model.detect(canvas).then((predictions) => {
					ctx.clearRect(0, 0, canvas.width, canvas.height);
					drawLine();
					drawPredictions(predictions);
					detect(model);
				});
			}

			function drawLine() {
				ctx.strokeStyle = "blue";
				ctx.lineWidth = 5;
				ctx.beginPath();
				ctx.moveTo(0, lineY);
				ctx.lineTo(canvas.width, lineY);
				ctx.stroke();
			}

			function drawPredictions(predictions) {
				predictions.forEach((prediction) => {
					if (prediction.class === "person") {
						ctx.beginPath();
						ctx.rect(prediction.bbox[0], prediction.bbox[1], prediction.bbox[2], prediction.bbox[3]);
						ctx.lineWidth = 2;
						ctx.strokeStyle = peopleCrossed.has(prediction.id) ? "red" : "green";
						ctx.stroke();

						// Check if person crosses the line
						if (prediction.bbox[1] + prediction.bbox[3] > lineY && !peopleCrossed.has(prediction.id)) {
							counter++;
							document.getElementById("counter").innerText = counter;
							peopleCrossed.add(prediction.id);
						}
					}
				});
			}
		</script>
	</body>
</html>
