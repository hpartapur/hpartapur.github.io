<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>People Counter</title>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-models/coco-ssd"></script>
		<style>
			canvas {
				position: absolute;
				left: 0;
				top: 0;
			}
		</style>
	</head>
	<body>
		<h1>People Counter: <span id="counter">0</span></h1>
		<video id="video" width="640" height="480" autoplay></video>
		<canvas id="canvas" width="640" height="480"></canvas>
		<script>
			let video;
			let net;
			let counter = 0;
			let peopleCrossed = new Set();
			const thresholdLineY = 300; // Threshold line Y-coordinate

			async function setupCamera() {
				video = document.getElementById("video");
				const stream = await navigator.mediaDevices.getUserMedia({
					video: true,
				});
				video.srcObject = stream;
				return new Promise((resolve) => {
					video.onloadedmetadata = () => {
						resolve(video);
					};
				});
			}

			async function loadModel() {
				net = await cocoSsd.load();
			}

			async function detect() {
				const predictions = await net.detect(video);
				const ctx = document.getElementById("canvas").getContext("2d");
				ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
				ctx.drawImage(video, 0, 0, ctx.canvas.width, ctx.canvas.height);
				drawThresholdLine(ctx);
				handleDetections(predictions, ctx);
				requestAnimationFrame(detect);
			}

			function drawThresholdLine(ctx) {
				ctx.beginPath();
				ctx.moveTo(0, thresholdLineY);
				ctx.lineTo(ctx.canvas.width, thresholdLineY);
				ctx.lineWidth = 2;
				ctx.strokeStyle = "red";
				ctx.stroke();
			}

			function handleDetections(predictions, ctx) {
				predictions.forEach((prediction) => {
					if (prediction.class === "person") {
						const [x, y, width, height] = prediction.bbox;
						ctx.beginPath();
						ctx.rect(x, y, width, height);
						ctx.lineWidth = 2;
						ctx.strokeStyle = "blue";
						ctx.stroke();

						// Calculate the center Y of the bounding box
						const centerY = y + height / 2;

						// Check if the person crosses the threshold line
						if (centerY > thresholdLineY && !peopleCrossed.has(prediction.id)) {
							peopleCrossed.add(prediction.id);
							counter++;
							document.getElementById("counter").innerText = counter;
						} else if (centerY < thresholdLineY && peopleCrossed.has(prediction.id)) {
							peopleCrossed.delete(prediction.id);
						}
					}
				});
			}

			async function main() {
				await setupCamera();
				await loadModel();
				detect();
			}

			main().catch((err) => {
				console.error(err);
				alert("An error occurred while initializing: " + err.message);
			});
		</script>
	</body>
</html>
